# grafana-mimir

これは grafana-mimir の Docker-Compose です。

## Mimir のアーキテクチャ

Mimir は分散型のメトリクスバックエンドで、以下のコンポーネントで構成されます。

### コアコンポーネント（必須）

1. **Distributor**: メトリクス受信と分散
2. **Ingester**: メトリクスをメモリに保持し、定期的にブロックとして書き込み
3. **Querier**: クエリ実行
4. **Query-frontend**: クエリの前処理（分割、キャッシュ、レート制限）
5. **Query-scheduler**: クエリのスケジューリング
6. **Store-gateway**: オブジェクトストレージからブロックを読み取り
7. **Compactor**: ブロックの圧縮と最適化

### オプションコンポーネント

- **Ruler**: アラート/記録ルールの評価
- **Alertmanager**: アラート通知の管理（オプション）
- **Overrides-exporter**: 設定のエクスポート

## ストレージを使用するコンポーネント一覧

### オブジェクトストレージ（S3）を使用するコンポーネント

1. **`blocks_storage`**（メトリクスブロック）

   - 用途: 時系列メトリクスデータのブロック
   - バケット: `mimir-blocks`
   - 状態: 設定済み

2. **`ruler_storage`**（ルール定義）

   - 用途: アラート/レコーディングルールの定義ファイル
   - バケット: `mimir-ruler`
   - 状態: 設定済み

3. **`alertmanager_storage`**（アラート状態）
   - 用途: アラート状態、サイレンス、通知履歴
   - バケット: `mimir-alertmanager`
   - 状態: 設定済み

### ローカルストレージ（ファイルシステム）を使用するコンポーネント

1. **`ingester`**（WAL - Write-Ahead Log）

   - 用途: 受信したメトリクスを一時的に保存（クラッシュ時の復旧用）
   - 場所: デフォルトで`/data/wal`（設定に明示されていない）
   - 特徴: ローカルディスクのみ（オブジェクトストレージではない）
   - 状態: 未設定（デフォルト動作）

2. **`compactor.data_dir`**（コンパクション作業ディレクトリ）

   - 用途: ブロックのコンパクション作業用の一時ディレクトリ
   - 場所: `/data/compactor`
   - 特徴: ローカルディスクのみ（作業用）
   - 状態: 設定済み

3. **`alertmanager.data_dir`**（アクティブ状態のローカルキャッシュ）

   - 用途: アクティブなアラート状態の高速アクセス用キャッシュ
   - 場所: `/data/alertmanager`
   - 特徴: ローカルディスク（`alertmanager_storage`と併用）
   - 状態: 設定済み

4. **`blocks_storage.tsdb.dir`**（TSDB ローカルディレクトリ）

   - 用途: TSDB のインデックスやメタデータのローカルキャッシュ
   - 場所: `/data/tsdb`
   - 特徴: ローカルディスク（パフォーマンス向上用）
   - 状態: 設定済み

5. **`activity_tracker.filepath`**（アクティビティログ）
   - 用途: リソース使用状況の追跡ログ
   - 場所: `/data/metrics-activity.log`
   - 特徴: ローカルファイル
   - 状態: 設定済み

## まとめ表

| コンポーネント              | ストレージタイプ | 用途                     | 共有が必要？ |
| --------------------------- | ---------------- | ------------------------ | ------------ |
| `blocks_storage`            | S3               | メトリクスブロック       | ✅ はい       |
| `ruler_storage`             | S3               | ルール定義               | ✅ はい       |
| `alertmanager_storage`      | S3               | アラート状態             | ✅ はい       |
| `ingester.wal`              | ローカル         | WAL（一時保存）          | ❌ いいえ     |
| `compactor.data_dir`        | ローカル         | 作業ディレクトリ         | ❌ いいえ     |
| `alertmanager.data_dir`     | ローカル         | アクティブ状態キャッシュ | ❌ いいえ     |
| `blocks_storage.tsdb.dir`   | ローカル         | TSDB キャッシュ          | ❌ いいえ     |
| `activity_tracker.filepath` | ローカル         | ログファイル             | ❌ いいえ     |

オブジェクトストレージ（S3）を使用するのは上記 3 つで、これらは複数インスタンス間で共有する必要があります。ローカルストレージは各インスタンスごとに独立して使用されます。

## 管理画面

- [grafana](http://grafana.localhost/)

## 参考
