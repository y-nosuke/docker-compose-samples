# ãƒ†ãƒŠãƒ³ãƒˆå›ºæœ‰ã®Alertmanagerè¨­å®šä¾‹
#
# ä½¿ç”¨æ–¹æ³•:
#   mimirtool alertmanager load \
#     --address=http://mimir.localhost:9009 \
#     --id=<tenant-id> \
#     tenant-alertmanager-config-example.yaml
#
# æ³¨æ„äº‹é …:
#   - ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€APIã‚­ãƒ¼ãªã©ï¼‰ã¯ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
#   - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆ*_fileï¼‰ã¯APIã§ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“
#   - ${VAR_NAME}å½¢å¼ã§ç’°å¢ƒå¤‰æ•°ã‚’å‚ç…§ã§ãã¾ã™

# ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
global:
  # ã‚¢ãƒ©ãƒ¼ãƒˆè§£æ±ºã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
  resolve_timeout: 5m

  # SMTPè¨­å®šï¼ˆãƒ¡ãƒ¼ãƒ«é€šçŸ¥ç”¨ï¼‰
  smtp_smarthost: 'smtp.example.com:587'
  smtp_from: 'alerts@example.com'
  smtp_auth_username: 'alerts@example.com'
  # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ï¼ˆAPIçµŒç”±ã§è¨­å®šã™ã‚‹å ´åˆï¼‰
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

# ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
route:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¬ã‚·ãƒ¼ãƒãƒ¼
  receiver: 'default'

  # ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹ãƒ©ãƒ™ãƒ«
  group_by: ['alertname', 'cluster', 'service']

  # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€ä¿¡ã™ã‚‹ã¾ã§ã®å¾…æ©Ÿæ™‚é–“
  group_wait: 10s

  # åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§æ–°ã—ã„ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ãŸå ´åˆã®é€ä¿¡é–“éš”
  group_interval: 10s

  # ã‚¢ãƒ©ãƒ¼ãƒˆãŒè§£æ±ºã•ã‚Œãªã„å ´åˆã®å†é€ä¿¡é–“éš”
  repeat_interval: 1h

  # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ï¼ˆå„ªå…ˆåº¦é †ï¼‰
  routes:
    # é‡å¤§åº¦ãŒcriticalã®ã‚¢ãƒ©ãƒ¼ãƒˆã¯å³åº§ã«é€ä¿¡
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
      continue: false

    # é‡å¤§åº¦ãŒwarningã®ã‚¢ãƒ©ãƒ¼ãƒˆ
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      repeat_interval: 30m
      continue: false

    # ç‰¹å®šã®ã‚µãƒ¼ãƒ“ã‚¹ã«é–¢ã™ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆ
    - match:
        service: 'database'
      receiver: 'database-team'
      continue: false

    # ç‰¹å®šã®ã‚¯ãƒ©ã‚¹ã‚¿ã«é–¢ã™ã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆ
    - match:
        cluster: 'production'
      receiver: 'production-alerts'
      continue: false

# æŠ‘åˆ¶ãƒ«ãƒ¼ãƒ«ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆã®é‡è¤‡ã‚’é˜²ãï¼‰
inhibit_rules:
  # criticalã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¦ã„ã‚‹å ´åˆã€åŒã˜ã‚¢ãƒ©ãƒ¼ãƒˆã®warningã‚’æŠ‘åˆ¶
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'cluster', 'service']

  # ã‚µãƒ¼ãƒ“ã‚¹å…¨ä½“ãŒãƒ€ã‚¦ãƒ³ã—ã¦ã„ã‚‹å ´åˆã€å€‹åˆ¥ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.*InstanceDown'
    equal: ['service', 'cluster']

# ãƒ¬ã‚·ãƒ¼ãƒãƒ¼ï¼ˆé€šçŸ¥å…ˆï¼‰ã®è¨­å®š
receivers:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¬ã‚·ãƒ¼ãƒãƒ¼
  - name: 'default'
    email_configs:
      - to: 'alerts@example.com'
        headers:
          Subject: 'Alert: {{ .GroupLabels.alertname }}'
        html: |
          <h2>ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥</h2>
          <p><strong>ã‚¢ãƒ©ãƒ¼ãƒˆå:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>é‡å¤§åº¦:</strong> {{ .CommonLabels.severity }}</p>
          <p><strong>é–‹å§‹æ™‚åˆ»:</strong> {{ .StartsAt }}</p>
          <hr>
          <h3>ãƒ©ãƒ™ãƒ«:</h3>
          <ul>
          {{ range .CommonLabels.SortedPairs }}
            <li><strong>{{ .Name }}:</strong> {{ .Value }}</li>
          {{ end }}
          </ul>
          <hr>
          <h3>ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³:</h3>
          <ul>
          {{ range .CommonAnnotations.SortedPairs }}
            <li><strong>{{ .Name }}:</strong> {{ .Value }}</li>
          {{ end }}
          </ul>
          <hr>
          <p><a href="{{ .ExternalURL }}">Alertmanagerã§ç¢ºèª</a></p>

  # é‡å¤§åº¦ãŒcriticalã®ã‚¢ãƒ©ãƒ¼ãƒˆç”¨ãƒ¬ã‚·ãƒ¼ãƒãƒ¼
  - name: 'critical-alerts'
    # ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
    email_configs:
      - to: 'critical-alerts@example.com'
        headers:
          Subject: '[CRITICAL] {{ .GroupLabels.alertname }}'
        html: |
          <h2 style="color: red;">é‡å¤§ãªã‚¢ãƒ©ãƒ¼ãƒˆ</h2>
          <p><strong>ã‚¢ãƒ©ãƒ¼ãƒˆå:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>é–‹å§‹æ™‚åˆ»:</strong> {{ .StartsAt }}</p>
          <p><a href="{{ .ExternalURL }}">è©³ç´°ã‚’ç¢ºèª</a></p>

    # Slacké€šçŸ¥
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#critical-alerts'
        title: 'ğŸš¨ Critical Alert: {{ .GroupLabels.alertname }}'
        text: |
          *ã‚¢ãƒ©ãƒ¼ãƒˆå:* {{ .GroupLabels.alertname }}
          *é‡å¤§åº¦:* {{ .CommonLabels.severity }}
          *é–‹å§‹æ™‚åˆ»:* {{ .StartsAt }}
          *è©³ç´°:* {{ .CommonAnnotations.description }}
        color: 'danger'
        send_resolved: true

    # PagerDutyé€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    # pagerduty_configs:
    #   - service_key: '${PAGERDUTY_SERVICE_KEY}'
    #     description: '{{ .GroupLabels.alertname }}'

  # é‡å¤§åº¦ãŒwarningã®ã‚¢ãƒ©ãƒ¼ãƒˆç”¨ãƒ¬ã‚·ãƒ¼ãƒãƒ¼
  - name: 'warning-alerts'
    email_configs:
      - to: 'warning-alerts@example.com'
        headers:
          Subject: '[WARNING] {{ .GroupLabels.alertname }}'

    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#warning-alerts'
        title: 'âš ï¸ Warning: {{ .GroupLabels.alertname }}'
        color: 'warning'

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒ¼ãƒ ç”¨ãƒ¬ã‚·ãƒ¼ãƒãƒ¼
  - name: 'database-team'
    email_configs:
      - to: 'database-team@example.com'

    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#database-alerts'

  # æœ¬ç•ªç’°å¢ƒç”¨ãƒ¬ã‚·ãƒ¼ãƒãƒ¼
  - name: 'production-alerts'
    email_configs:
      - to: 'production-oncall@example.com'

    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#production-alerts'

    # Webhooké€šçŸ¥ï¼ˆã‚«ã‚¹ã‚¿ãƒ çµ±åˆç”¨ï¼‰
    webhook_configs:
      - url: '${WEBHOOK_URL}'
        http_config:
          bearer_token: '${WEBHOOK_BEARER_TOKEN}'
        send_resolved: true
